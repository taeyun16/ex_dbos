name: CI

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ci-${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  OTP_VERSION: "28.0"
  ELIXIR_VERSION: "1.19.4"

jobs:
  changes:
    name: Detect Changes
    runs-on: ubuntu-24.04
    outputs:
      code: ${{ steps.detect.outputs.code }}
      docs: ${{ steps.detect.outputs.docs }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed areas
        id: detect
        shell: bash
        run: |
          set -euo pipefail

          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            git fetch --no-tags --depth=1 origin "${{ github.base_ref }}"
            range="origin/${{ github.base_ref }}...${{ github.sha }}"
          else
            before="${{ github.event.before }}"
            if [[ -z "$before" || "$before" == "0000000000000000000000000000000000000000" ]]; then
              before="$(git rev-list --max-parents=0 HEAD)"
            fi
            range="$before...${{ github.sha }}"
          fi

          changed_files="$(git diff --name-only "$range")"

          echo "Changed files:"
          if [[ -n "$changed_files" ]]; then
            while IFS= read -r file; do
              [[ -z "$file" ]] && continue
              echo " - $file"
            done <<< "$changed_files"
          else
            echo " - <none>"
          fi

          code=false
          docs=false

          while IFS= read -r file; do
            [[ -z "$file" ]] && continue

            case "$file" in
              lib/*|test/*|priv/*|mix.exs|mix.lock|.formatter.exs|.github/workflows/*)
                code=true
                ;;
            esac

            case "$file" in
              README.md|CONTRIBUTING.md|LICENSE|docs/*|examples/*|docker-compose.yml)
                docs=true
                ;;
            esac
          done <<< "$changed_files"

          echo "code=$code" >> "$GITHUB_OUTPUT"
          echo "docs=$docs" >> "$GITHUB_OUTPUT"

  quality:
    name: Quality
    runs-on: ubuntu-24.04
    needs: changes
    if: >-
      needs.changes.outputs.code == 'true' &&
      (github.event_name != 'pull_request' || github.event.pull_request.draft == false)
    env:
      MIX_ENV: test
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up BEAM
        uses: erlef/setup-beam@v1
        with:
          otp-version: ${{ env.OTP_VERSION }}
          elixir-version: ${{ env.ELIXIR_VERSION }}
          version-type: strict

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: deps
          key: ${{ runner.os }}-deps-${{ env.OTP_VERSION }}-${{ env.ELIXIR_VERSION }}-${{ hashFiles('mix.lock') }}
          restore-keys: |
            ${{ runner.os }}-deps-${{ env.OTP_VERSION }}-${{ env.ELIXIR_VERSION }}-
            ${{ runner.os }}-deps-

      - name: Cache build
        uses: actions/cache@v4
        with:
          path: _build
          key: ${{ runner.os }}-build-${{ env.OTP_VERSION }}-${{ env.ELIXIR_VERSION }}-${{ hashFiles('mix.lock') }}
          restore-keys: |
            ${{ runner.os }}-build-${{ env.OTP_VERSION }}-${{ env.ELIXIR_VERSION }}-
            ${{ runner.os }}-build-

      - name: Install dependencies
        run: mix deps.get

      - name: Run quality pipeline
        run: mix quality

  docs:
    name: Docs Consistency
    runs-on: ubuntu-24.04
    needs: changes
    if: needs.changes.outputs.docs == 'true' && needs.changes.outputs.code != 'true'
    env:
      MIX_ENV: test
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up BEAM
        uses: erlef/setup-beam@v1
        with:
          otp-version: ${{ env.OTP_VERSION }}
          elixir-version: ${{ env.ELIXIR_VERSION }}
          version-type: strict

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: deps
          key: ${{ runner.os }}-deps-${{ env.OTP_VERSION }}-${{ env.ELIXIR_VERSION }}-${{ hashFiles('mix.lock') }}
          restore-keys: |
            ${{ runner.os }}-deps-${{ env.OTP_VERSION }}-${{ env.ELIXIR_VERSION }}-
            ${{ runner.os }}-deps-

      - name: Cache build
        uses: actions/cache@v4
        with:
          path: _build
          key: ${{ runner.os }}-build-${{ env.OTP_VERSION }}-${{ env.ELIXIR_VERSION }}-${{ hashFiles('mix.lock') }}
          restore-keys: |
            ${{ runner.os }}-build-${{ env.OTP_VERSION }}-${{ env.ELIXIR_VERSION }}-
            ${{ runner.os }}-build-

      - name: Install dependencies
        run: mix deps.get

      - name: Run documentation checks
        run: mix docs.check

  no-op:
    name: No Relevant Changes
    runs-on: ubuntu-24.04
    needs: changes
    if: needs.changes.outputs.code != 'true' && needs.changes.outputs.docs != 'true'
    steps:
      - name: Skip
        run: echo "No code or docs related changes detected."
